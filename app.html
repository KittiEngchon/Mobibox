<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏≠‡∏õ | Mobibox</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
  <header>
    <a href="index.html">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</a>
    <h1 id="appName">...</h1>
    <button id="connectBtn">üîó Connect Wallet</button>
    <span id="walletAddress">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
  </header>

  <main id="appDetail">
    <img id="appImage" src="" alt="" />
    <p id="appDesc"></p>
    <div id="badges"></div>
    <p>Chain: <span id="appChain"></span></p>
    <p>Category: <span id="appCategory"></span></p>
    <p>‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤: <span id="appDev"></span> <button id="viewProfile">üëÅÔ∏è ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button></p>
    <a id="appLink" class="btn" target="_blank">üåê ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå</a>

    <section id="trustSection">
      <h2>üß† Trust Score (AI)</h2>
      <p id="trustScore">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </section>

    <section id="shareSection">
       <h2>üîó ‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏≠‡∏õ</h2>
       <button id="copyLink">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
       <button id="showQR">üì± QR Code</button>
       <div id="qrBox" style="margin-top:10px;"></div>
    </section>

    <section id="reviewSection">
      <h2>‚≠ê ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
      <div id="reviewsList"></div>
      <div id="reviewForm" style="display:none;">
        <textarea id="reviewComment" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß..."></textarea>
        <input type="number" id="reviewRating" min="1" max="5" placeholder="‡πÄ‡∏£‡∏ï 1-5" />
        <button id="submitReview">üì§ ‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="libs/wallet.js"></script>
  <script src="libs/review.js"></script>
  <script src="libs/ai.js"></script>
  <script src="libs/novavault.js"></script>
  <script src="libs/ui.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const appId = params.get('id');

    async function init() {
      try {
        const res = await fetch('./data/apps.json');
        const apps = await res.json();
        const app = apps.find(a => a.id === appId);
        if (!app) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏≠‡∏õ");

        document.getElementById('appName').textContent = app.name;
        document.getElementById('appImage').src = app.image;
        document.getElementById('appDesc').textContent = app.description;
        document.getElementById('appChain').textContent = app.chain;
        document.getElementById('appCategory').textContent = app.category;
        document.getElementById('appDev').textContent = app.developer;
        document.getElementById('appLink').href = app.website;
        document.getElementById('badges').innerHTML = app.badges.map(b => `<span class="badge">${b}</span>`).join(' ');

        const reviews = await getReviewsByApp(appId);
        const list = document.getElementById('reviewsList');
        list.innerHTML = reviews.map(r => `
          <div class="review">
            <p>‚≠ê ${r.rating}</p>
            <p>${r.comment}</p>
            <small>${r.reviewer}</small>
          </div>
        `).join('');

        const insights = await getAIInsights(appId, reviews);
        document.getElementById('trustScore').textContent = `${insights.trustScore}/100 - ${insights.suggestion}`;

        const user = await getCurrentWalletAddress();
        if (user) {
          const addrSpan = document.getElementById("walletAddress");
          if (addrSpan) addrSpan.textContent = user.slice(0, 6) + "..." + user.slice(-4);
        }

        if (await checkReviewEligibility(user)) {
          document.getElementById('reviewForm').style.display = 'block';
          document.getElementById('submitReview').onclick = () => {
            const comment = document.getElementById('reviewComment').value;
            const rating = parseInt(document.getElementById('reviewRating').value);
            submitReview({ appId, reviewer: user, comment, rating });
          };
        }

        document.getElementById('viewProfile').onclick = () => {
          showProfileModal(app.developer);
        };

        // ‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå
        document.getElementById("copyLink").onclick = () => {
          const url = location.href;
          navigator.clipboard.writeText(url);
          showToast("‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß");
        };

        document.getElementById("showQR").onclick = () => {
          const box = document.getElementById("qrBox");
          box.innerHTML = "";
          new QRCode(box, {
            text: location.href,
            width: 160,
            height: 160
          });
        };

      } catch (err) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
      }
    }

    document.getElementById("connectBtn").onclick = connectWallet;
    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>

